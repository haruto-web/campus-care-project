{% extends 'base.html' %}

{% block title %}BT AI Assistant - Counselor{% endblock %}

{% block content %}
<div class="space-y-6">
    <h2 class="text-3xl font-bold text-gray-800">ðŸ¤– BT AI Assistant</h2>
    
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center space-x-4">
            <div class="bg-white/20 backdrop-blur-sm p-4 rounded-xl">
                <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                    <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                </svg>
            </div>
            <div>
                <h3 class="text-2xl font-bold">Your Intelligent Counseling Assistant</h3>
                <p class="text-purple-100 mt-1">Get AI-powered insights for student interventions, reports, and support strategies</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <button onclick="showInterventionForm()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    Create Intervention
                </button>

                <button onclick="autoCreateInterventions()" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
                    </svg>
                    Auto-Create All Interventions
                </button>

                <button onclick="generateReport()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
                        <path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/>
                    </svg>
                    Generate Report
                </button>

                <button onclick="showBehaviorAnalysis()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    Analyze Behavior
                </button>

                <button onclick="generateWeeklySummary()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                    Weekly Summary
                </button>

                <button onclick="showDraftEmail()" class="w-full bg-pink-600 hover:bg-pink-700 text-white px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                    Draft Parent Email
                </button>

                <button onclick="showSearchForm()" class="w-full border-2 border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    Search Student
                </button>

                <button onclick="showAskAI()" class="w-full border-2 border-purple-600 text-purple-600 hover:bg-purple-50 px-4 py-3 rounded-lg flex items-center justify-start transition font-medium">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                    </svg>
                    Ask AI Anything
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow">
            <div class="bg-purple-600 text-white px-6 py-4 rounded-t-lg">
                <h3 class="text-lg font-semibold">ðŸ’¬ Chat with BT</h3>
            </div>
            <div class="flex flex-col" style="height: 600px;">
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                    <!-- Welcome Message -->
                    <div class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold text-sm">
                            BT
                        </div>
                        <div class="ml-3 bg-white rounded-lg px-4 py-3 shadow-sm max-w-md border border-gray-200">
                            <p class="text-gray-800 text-sm">Hi! I'm <strong>BT</strong>, your AI assistant. I'm here to help you with student interventions, reports, and counseling insights. Click a quick action button or ask me anything!</p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div id="inputArea" class="p-4 bg-white border-t border-gray-200 hidden">
                    <div class="flex space-x-2">
                        <input type="text" id="userInput" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <button onclick="sendMessage()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition font-medium">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const csrftoken = '{{ csrf_token }}';
let currentAction = null;
let selectedStudentId = null;

function addMessage(text, isUser = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start' + (isUser ? ' justify-end' : '');
    
    if (isUser) {
        messageDiv.innerHTML = `
            <div class="bg-purple-600 text-white rounded-lg px-4 py-3 shadow-sm max-w-md">
                <p>${text}</p>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold">
                BT
            </div>
            <div class="ml-3 bg-white rounded-lg px-4 py-3 shadow-sm max-w-md">
                <p class="text-gray-800">${text}</p>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showInterventionForm() {
    addMessage('Select a student to create an intervention recommendation:', false);
    
    // Show student selection interface
    const chatMessages = document.getElementById('chatMessages');
    const selectionDiv = document.createElement('div');
    selectionDiv.className = 'bg-white rounded-lg p-4 shadow-sm border border-gray-200';
    selectionDiv.innerHTML = `
        <h4 class="font-semibold text-gray-800 mb-3">Find Student</h4>
        
        <!-- Filters -->
        <div class="grid grid-cols-3 gap-2 mb-3">
            <select id="gradeFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                <option value="">All Grades</option>
                <option value="7">Grade 7</option>
                <option value="8">Grade 8</option>
                <option value="9">Grade 9</option>
                <option value="10">Grade 10</option>
            </select>
            <input type="text" id="sectionFilter" placeholder="Section..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
            <select id="genderFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                <option value="">All Genders</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
        </div>
        
        <!-- Search -->
        <input type="text" id="studentSearchBox" placeholder="Search by name or email..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 mb-3">
        
        <!-- Results -->
        <div id="studentResults" class="max-h-64 overflow-y-auto space-y-2">
            <p class="text-gray-500 text-sm text-center py-4">Loading students...</p>
        </div>
    `;
    chatMessages.appendChild(selectionDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    currentAction = 'create_intervention';
    
    // Load students
    fetch('/wellness/api/students/')
        .then(response => response.json())
        .then(data => {
            window.allStudents = data;
            displayStudentResults(data);
            
            // Add event listeners for filters
            document.getElementById('gradeFilter').addEventListener('change', filterStudentList);
            document.getElementById('sectionFilter').addEventListener('input', filterStudentList);
            document.getElementById('genderFilter').addEventListener('change', filterStudentList);
            document.getElementById('studentSearchBox').addEventListener('input', filterStudentList);
        })
        .catch(error => {
            document.getElementById('studentResults').innerHTML = '<p class="text-red-500 text-sm text-center py-4">Error loading students</p>';
        });
}

function filterStudentList() {
    const grade = document.getElementById('gradeFilter').value;
    const section = document.getElementById('sectionFilter').value.toLowerCase();
    const gender = document.getElementById('genderFilter').value;
    const search = document.getElementById('studentSearchBox').value.toLowerCase();
    
    let filtered = window.allStudents.filter(s => {
        if (grade && s.year_level != grade) return false;
        if (section && (!s.section || !s.section.toLowerCase().includes(section))) return false;
        if (gender && s.gender !== gender) return false;
        if (search && !s.name.toLowerCase().includes(search) && !s.email.toLowerCase().includes(search)) return false;
        return true;
    });
    
    displayStudentResults(filtered);
}

function displayStudentResults(students) {
    const resultsDiv = document.getElementById('studentResults');
    
    if (students.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No students found</p>';
        return;
    }
    
    // Sort by risk level (high first)
    students.sort((a, b) => {
        const riskOrder = { 'high': 0, 'medium': 1, 'low': 2, null: 3 };
        return riskOrder[a.risk_level] - riskOrder[b.risk_level];
    });
    
    resultsDiv.innerHTML = students.slice(0, 20).map(s => {
        let riskBadge = '';
        if (s.risk_level === 'high') {
            riskBadge = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold ml-2">HIGH RISK</span>';
        } else if (s.risk_level === 'medium') {
            riskBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold ml-2">Medium</span>';
        }
        
        return `
        <div class="p-3 border border-gray-200 rounded-lg hover:bg-purple-50 cursor-pointer transition" onclick="selectStudent(${s.id}, \`${s.name.replace(/`/g, '')}\`)">
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-semibold text-gray-800 text-sm">${s.name}${riskBadge}</p>
                    <p class="text-xs text-gray-500">${s.email}</p>
                </div>
                <div class="text-right">
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Grade ${s.year_level || 'N/A'}</span>
                    ${s.section ? `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs ml-1">${s.section}</span>` : ''}
                </div>
            </div>
        </div>
    `;
    }).join('');
    
    if (students.length > 20) {
        resultsDiv.innerHTML += '<p class="text-gray-500 text-xs text-center py-2">Showing first 20 of ' + students.length + ' students</p>';
    }
}

function selectStudent(studentId, studentName) {
    addMessage(`Selected: ${studentName}`, true);
    addMessage('Analyzing student profile and generating intervention recommendations...', false);
    
    fetch('/ai/counselor/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            action: 'create_intervention',
            student_id: studentId
        })
    })
    .then(response => response.json())
    .then(data => {
        let response = data.response + '<br><br><strong>Recommendations:</strong><ul class="list-disc ml-4 mt-2">';
        if (Array.isArray(data.recommendations)) {
            data.recommendations.forEach(rec => {
                const text = typeof rec === 'string' ? rec : (rec.recommendation || JSON.stringify(rec));
                response += `<li>${text}</li>`;
            });
        }
        response += '</ul>';
        
        if (data.intervention_created) {
            response += '<br><div class="mt-3 p-3 bg-green-100 border border-green-300 rounded-lg text-green-800 text-sm">âœ… <strong>Intervention auto-created!</strong> Check the Alerts page to review details.</div>';
        }
        
        addMessage(response, false);
        currentAction = null;
    })
    .catch(error => {
        addMessage('Student not found or error occurred.', false);
    });
}

function showBehaviorAnalysis() {
    addMessage('Select a student to analyze their behavior pattern:', false);
    
    const chatMessages = document.getElementById('chatMessages');
    const selectionDiv = document.createElement('div');
    selectionDiv.className = 'bg-white rounded-lg p-4 shadow-sm border border-gray-200';
    selectionDiv.innerHTML = `
        <h4 class="font-semibold text-gray-800 mb-3">Find Student</h4>
        <input type="text" id="behaviorStudentSearch" placeholder="Search by name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 mb-3">
        <div id="behaviorStudentResults" class="max-h-48 overflow-y-auto space-y-2">
            <p class="text-gray-500 text-sm text-center py-4">Loading students...</p>
        </div>
    `;
    chatMessages.appendChild(selectionDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    currentAction = 'analyze_behavior';
    
    fetch('/wellness/api/students/')
        .then(response => response.json())
        .then(data => {
            window.behaviorStudents = data;
            displayBehaviorStudents(data);
            document.getElementById('behaviorStudentSearch').addEventListener('input', function() {
                const search = this.value.toLowerCase();
                const filtered = window.behaviorStudents.filter(s => s.name.toLowerCase().includes(search));
                displayBehaviorStudents(filtered);
            });
        });
}

function displayBehaviorStudents(students) {
    const resultsDiv = document.getElementById('behaviorStudentResults');
    
    // Sort by risk level (high first)
    students.sort((a, b) => {
        const riskOrder = { 'high': 0, 'medium': 1, 'low': 2, null: 3 };
        return riskOrder[a.risk_level] - riskOrder[b.risk_level];
    });
    
    resultsDiv.innerHTML = students.slice(0, 10).map(s => {
        let riskBadge = '';
        if (s.risk_level === 'high') {
            riskBadge = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold ml-2">HIGH RISK</span>';
        } else if (s.risk_level === 'medium') {
            riskBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold ml-2">Medium</span>';
        }
        
        return `
            <div class="p-2 border border-gray-200 rounded hover:bg-purple-50 cursor-pointer text-sm" onclick="analyzeBehavior(${s.id}, \`${s.name.replace(/`/g, '')}\`)">
                <div class="flex items-center justify-between">
                    <p class="font-semibold text-gray-800">${s.name}</p>
                    ${riskBadge}
                </div>
            </div>
        `;
    }).join('');
}

function analyzeBehavior(studentId, studentName) {
    addMessage(`Analyzing behavior pattern for: ${studentName}`, true);
    addMessage('Analyzing attendance, submissions, and wellness data...', false);
    
    fetch('/ai/counselor/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            action: 'analyze_behavior',
            student_id: studentId
        })
    })
    .then(response => response.json())
    .then(data => {
        // Format behavior analysis
        const sections = data.response.split('\n\n');
        let html = '<div class="bg-purple-50 border border-purple-200 rounded-lg p-4 space-y-3">';
        html += '<h4 class="font-bold text-purple-800 text-sm mb-3">ðŸ“Š Behavior Analysis</h4>';
        
        sections.forEach(section => {
            if (section.trim()) {
                const lines = section.split('\n');
                if (lines[0].includes(':')) {
                    const [title, ...content] = lines[0].split(':');
                    html += `<div class="bg-white rounded-lg p-3">
                        <h5 class="font-semibold text-gray-800 text-sm mb-2">${title.trim()}</h5>
                        <div class="text-gray-600 text-sm space-y-1">`;
                    
                    if (content.length > 0) {
                        html += `<p>${content.join(':').trim()}</p>`;
                    }
                    
                    lines.slice(1).forEach(line => {
                        if (line.trim().startsWith('-') || line.trim().startsWith('â€¢')) {
                            html += `<div class="flex items-start ml-2"><span class="text-purple-600 mr-2">â€¢</span><span>${line.trim().substring(1).trim()}</span></div>`;
                        } else if (line.trim()) {
                            html += `<p>${line.trim()}</p>`;
                        }
                    });
                    
                    html += '</div></div>';
                } else {
                    html += `<p class="text-gray-700 text-sm">${section}</p>`;
                }
            }
        });
        html += '</div>';
        
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start';
        messageDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold text-sm">BT</div>
            <div class="ml-3 max-w-2xl">${html}</div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        currentAction = null;
    })
    .catch(error => {
        addMessage('Error analyzing behavior.', false);
    });
}

function generateWeeklySummary() {
    addMessage('Generating weekly summary...', false);
    
    fetch('/ai/counselor/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            action: 'weekly_summary'
        })
    })
    .then(response => response.json())
    .then(data => {
        // Format weekly summary with visual cards
        const d = data.data;
        let html = `
        <div class="bg-gradient-to-br from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl p-5 space-y-4 max-w-2xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="bg-orange-500 text-white rounded-full p-3">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <h4 class="text-xl font-bold text-gray-800">This Week's Snapshot</h4>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-lg p-4 shadow-sm border border-orange-100">
                    <div class="text-3xl font-bold text-orange-600">${d.new_alerts}</div>
                    <div class="text-sm text-gray-600 mt-1">New Alerts</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-red-100">
                    <div class="text-3xl font-bold text-red-600">${d.new_high_risk_students}</div>
                    <div class="text-sm text-gray-600 mt-1">High-Risk Students</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-100">
                    <div class="text-3xl font-bold text-blue-600">${d.new_interventions}</div>
                    <div class="text-sm text-gray-600 mt-1">Interventions</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-purple-100">
                    <div class="text-3xl font-bold text-purple-600">${d.new_concerns}</div>
                    <div class="text-sm text-gray-600 mt-1">Teacher Concerns</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 mt-4 border border-orange-100">
                <div class="text-gray-700 text-sm leading-relaxed whitespace-pre-line">${data.response.replace(/\*\*/g, '').replace(/\*/g, '')}</div>
            </div>
        </div>
        `;
        
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start';
        messageDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold text-sm">BT</div>
            <div class="ml-3">${html}</div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
        addMessage('Error generating summary.', false);
    });
}

function showDraftEmail() {
    addMessage('Select a student to draft a parent email:', false);
    
    const chatMessages = document.getElementById('chatMessages');
    const selectionDiv = document.createElement('div');
    selectionDiv.className = 'bg-white rounded-lg p-4 shadow-sm border border-gray-200';
    selectionDiv.innerHTML = `
        <h4 class="font-semibold text-gray-800 mb-3">Find Student</h4>
        <input type="text" id="emailStudentSearch" placeholder="Search by name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 mb-3">
        <div id="emailStudentResults" class="max-h-48 overflow-y-auto space-y-2">
            <p class="text-gray-500 text-sm text-center py-4">Loading students...</p>
        </div>
    `;
    chatMessages.appendChild(selectionDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    currentAction = 'draft_email';
    
    fetch('/wellness/api/students/')
        .then(response => response.json())
        .then(data => {
            window.emailStudents = data;
            displayEmailStudents(data);
            document.getElementById('emailStudentSearch').addEventListener('input', function() {
                const search = this.value.toLowerCase();
                const filtered = window.emailStudents.filter(s => s.name.toLowerCase().includes(search));
                displayEmailStudents(filtered);
            });
        });
}

function displayEmailStudents(students) {
    const resultsDiv = document.getElementById('emailStudentResults');
    
    // Sort by risk level (high first)
    students.sort((a, b) => {
        const riskOrder = { 'high': 0, 'medium': 1, 'low': 2, null: 3 };
        return riskOrder[a.risk_level] - riskOrder[b.risk_level];
    });
    
    resultsDiv.innerHTML = students.slice(0, 10).map(s => {
        let riskBadge = '';
        if (s.risk_level === 'high') {
            riskBadge = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-semibold ml-2">HIGH RISK</span>';
        } else if (s.risk_level === 'medium') {
            riskBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs font-semibold ml-2">Medium</span>';
        }
        
        return `
            <div class="p-2 border border-gray-200 rounded hover:bg-pink-50 cursor-pointer text-sm" onclick="draftEmail(${s.id}, \`${s.name.replace(/`/g, '')}\`)">
                <div class="flex items-center justify-between">
                    <p class="font-semibold text-gray-800">${s.name}</p>
                    ${riskBadge}
                </div>
            </div>
        `;
    }).join('');
}

function draftEmail(studentId, studentName) {
    addMessage(`Drafting parent email for: ${studentName}`, true);
    addMessage('Creating professional email draft...', false);
    
    fetch('/ai/counselor/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            action: 'draft_email',
            student_id: studentId,
            purpose: 'academic concern'
        })
    })
    .then(response => response.json())
    .then(data => {
        addMessage(data.response.replace(/\n/g, '<br>'), false);
        currentAction = null;
    })
    .catch(error => {
        addMessage('Error drafting email.', false);
    });
}

function generateReport() {
    addMessage('Generating comprehensive report summary...', false);
    
    fetch('/ai/counselor/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            action: 'generate_report'
        })
    })
    .then(response => response.json())
    .then(data => {
        const d = data.data;
        
        let html = `
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-5 space-y-4 max-w-2xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="bg-green-500 text-white rounded-full p-3">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
                        <path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"/>
                    </svg>
                </div>
                <h4 class="text-xl font-bold text-gray-800">System Overview Report</h4>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-lg p-4 shadow-sm border border-red-100">
                    <div class="text-3xl font-bold text-red-600">${d.high_risk_count}</div>
                    <div class="text-sm text-gray-600 mt-1">High-Risk Students</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-yellow-100">
                    <div class="text-3xl font-bold text-yellow-600">${d.medium_risk_count}</div>
                    <div class="text-sm text-gray-600 mt-1">Medium-Risk Students</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-orange-100">
                    <div class="text-3xl font-bold text-orange-600">${d.unresolved_alerts}</div>
                    <div class="text-sm text-gray-600 mt-1">Unresolved Alerts</div>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-100">
                    <div class="text-3xl font-bold text-blue-600">${d.pending_interventions}</div>
                    <div class="text-sm text-gray-600 mt-1">Pending Interventions</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 mt-4 border border-green-100">
                <div class="text-gray-700 text-sm leading-relaxed whitespace-pre-line">${data.response.replace(/\*\*/g, '').replace(/\*/g, '')}</div>
            </div>
        </div>
        `;
        
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start';
        messageDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold text-sm">BT</div>
            <div class="ml-3">${html}</div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
        addMessage('Error generating report. Please try again.', false);
    });
}

function showSearchForm() {
    addMessage('Search for students by filters. Please provide: grade_level (7-10), section, or severity (low/medium/high/critical). Example: "grade 7 section apple high"', false);
    document.getElementById('inputArea').classList.remove('hidden');
    currentAction = 'search_student';
}

function showAskAI() {
    addMessage('Ask me anything about counseling, student support, or interventions!', false);
    document.getElementById('inputArea').classList.remove('hidden');
    currentAction = 'ask_ai';
}

function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessage(message, true);
    input.value = '';
    
    if (currentAction === 'create_intervention') {
        // Handled by selectStudent function
        return;
    } else if (currentAction === 'search_student') {
        const filters = {};
        if (message.includes('grade')) {
            const match = message.match(/grade\s+(\d+)/i);
            if (match) filters.year_level = match[1];
        }
        if (message.includes('section')) {
            const match = message.match(/section\s+(\w+)/i);
            if (match) filters.section = match[1];
        }
        if (message.match(/\b(low|medium|high|critical)\b/i)) {
            filters.severity = message.match(/\b(low|medium|high|critical)\b/i)[0].toLowerCase();
        }
        
        fetch('/ai/counselor/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                action: 'search_student',
                filters: filters
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.students.length > 0) {
                let response = '<strong>Found students:</strong><ul class="list-disc ml-4 mt-2">';
                data.students.forEach(s => {
                    response += `<li>${s.name} - Grade ${s.year_level} ${s.section} (ID: ${s.id})</li>`;
                });
                response += '</ul>';
                addMessage(response, false);
            } else {
                addMessage('No students found matching your criteria.', false);
            }
            document.getElementById('inputArea').classList.add('hidden');
            currentAction = null;
        });
    } else if (currentAction === 'ask_ai') {
        fetch('/ai/counselor/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                action: 'ask_ai',
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            addMessage(data.response, false);
        })
        .catch(error => {
            addMessage('Error processing your request.', false);
        });
    }
}

document.getElementById('userInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

function autoCreateInterventions() {
    if (!confirm('This will automatically create interventions for ALL high-risk students who don\'t have scheduled interventions. Continue?')) {
        return;
    }
    
    addMessage('Scanning all high-risk students and creating interventions...', false);
    
    fetch('/ai/counselor/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            action: 'auto_create_interventions'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = `
            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                <div class="flex items-center space-x-3 mb-2">
                    <div class="bg-green-500 text-white rounded-full p-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h4 class="text-lg font-bold text-green-800">âœ… Auto-Intervention Complete!</h4>
                </div>
                <p class="text-green-700 font-semibold text-lg">${data.message}</p>
                <p class="text-green-600 text-sm mt-2">Check the <a href="/wellness/interventions/" class="underline font-semibold">Interventions page</a> and <a href="/wellness/alerts/" class="underline font-semibold">Alerts page</a> to review all created interventions.</p>
            </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start';
            messageDiv.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white font-bold text-sm">BT</div>
                <div class="ml-3 max-w-2xl">${html}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
            addMessage('Error creating interventions. Please try again.', false);
        }
    })
    .catch(error => {
        addMessage('Error processing request. Please try again.', false);
    });
}
</script>
{% endblock %}
